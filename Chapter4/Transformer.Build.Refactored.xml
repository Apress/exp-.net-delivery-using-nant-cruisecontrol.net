<?xml version="1.0" encoding="utf-8" ?> 
<project name="Transformer" default="help">
	<description>Build file for the Transformer application.</description>

	<property name="nant.onfailure" value="fail"/>

	<property name="core.directory" value="D:\dotNetDelivery\BuildArea"/>
	<property name="core.source" value="${core.directory}\Source"/>
	<property name="core.output" value="${core.directory}\Output"/>
	<property name="core.docs" value="${core.directory}\Docs"/>
	<property name="core.reports" value="${core.directory}\Reports"/>
	<property name="core.distribution" value="${core.directory}\Distribution"/>
	<property name="core.publish" value="${core.directory}\Publish"/>

	<property name="vss.dbpath" value="D:\dotNetDelivery\VSS\srcsafe.ini"/>
	<property name="vss.path" value="$/Solutions/Transformer/"/>

     <loadtasks assembly="D:\dotNetDelivery\Tools\NAntContrib\0.85rc1\bin\NAnt.Contrib.Tasks.dll"/>
     <loadtasks assembly="D:\dotNetDelivery\Tools\NUnit2Report\1.2.2\bin\NAnt.NUnit2ReportTasks.dll"/>
	<sysinfo/>
	
	<target name="go" description="The main target for full build process execution." depends="clean, get, version1, version2, build, test, document, publish, notify"/>

	<target name="clean" description="Clean up the build environment.">
		<delete dir="${core.source}\" failonerror="false"/>
		<delete dir="${core.output}\" failonerror="false"/>
		<delete dir="${core.docs}\" failonerror="false"/>
		<delete dir="${core.reports}\" failonerror="false"/>
		<delete dir="${core.distribution}\" failonerror="false"/>

		<mkdir dir="${core.source}\" failonerror="false"/>
		<mkdir dir="${core.output}\" failonerror="false"/>
		<mkdir dir="${core.docs}\" failonerror="false"/>
		<mkdir dir="${core.reports}\" failonerror="false"/>
		<mkdir dir="${core.distribution}\" failonerror="false"/>
		<mkdir dir="${core.publish}\" failonerror="false"/>

	</target>

	<target name="get" description="Grab the source code.">
		<vssget
			user="builder"
			password="builder"
			localpath="${core.source}\"
			recursive="true"
			replace="true"
			dbpath="${vss.dbpath}"
			path="${vss.path}"
		/>
	</target>

	<target name="version1" description="Apply versioning to the source code files.">

		<property name="sys.version" value="0.0.0.0"/>

		<ifnot test="${debug}">
			<version buildtype="increment" revisiontype="increment" path="Transformer.Build.Number"/>
		</ifnot>

		<attrib file="${core.source}\CommonAssemblyInfo.cs" readonly="false" />

		<asminfo output="${core.source}\CommonAssemblyInfo.cs" language="CSharp">
			<imports>
				<import name="System" />
				<import name="System.Reflection"/>
			</imports>
			<attributes>
				<attribute type="AssemblyVersionAttribute" value="${sys.version}" />
				<attribute type="AssemblyProductAttribute" value="Transformer" />
				<attribute type="AssemblyCopyrightAttribute" value="Copyright (c) 2005, Etomic Ltd."/>
			</attributes>
		</asminfo>

		<attrib file="${core.source}\CommonAssemblyInfo.cs" readonly="true" />
	</target>

	<target name="version2">
		<ifnot test="${debug}">
			<vsslabel
				user="builder"
				password="builder"
				dbpath="${vss.dbpath}"
				path="${vss.path}"
				comment="Automated Label"
				label="NAnt - ${sys.version}"
			/>
		</ifnot>
	</target>

	<target name="build" description="Compile the application.">
		<solution solutionfile="${core.source}\Transformer.sln" configuration="Debug" outputdir="${core.output}\"/>
	</target>

	<target name="test" description="Apply the unit tests.">
		<property name="nant.onfailure" value="fail.test"/>
	
		<nunit2>
			<formatter type="Xml" usefile="true" extension=".xml" outputdir="${core.reports}\" />
			<test assemblyname="${core.output}\TransformerTests.dll" />
		</nunit2>

		<nunit2report out="${core.reports}\NUnit.html">
			<fileset>
				<include name="${core.reports}\TransformerTests.dll-results.xml" />
			</fileset>
		</nunit2report>

		<exec program="D:\dotNetDelivery\Tools\FxCop\1.30\FxCopCmd.exe" commandline="/f:${core.output}\TransformerEngine.dll /f:${core.output}\TransformerGui.exe /o:${core.reports}\fxcop.xml /r:D:\dotNetDelivery\Tools\FxCop\1.30\Rules\" failonerror="false"/>

		<style style="D:\dotNetDelivery\Tools\FxCop\1.30\Xml\FxCopReport.xsl" in="${core.reports}\fxcop.xml" out="${core.reports}\fxcop.html"/>
		
		<property name="nant.onfailure" value="fail"/>
	
	</target>

	<target name="document" description="Generate documentation and reports.">
		<ndoc>
			<assemblies basedir="${core.output}\">
                <include name="TransformerEngine.dll" />
                <include name="TransformerGui.dll" />
            </assemblies>
            <summaries basedir="${core.output}\">
                <include name="TransformerEngine.xml" />
                <include name="TransformerGui.xml" />
            </summaries>
            <documenters>
                <documenter name="MSDN">
                    <property name="OutputDirectory" value="${core.docs}\" />
                    <property name="HtmlHelpName" value="Transformer" />
                    <property name="HtmlHelpCompilerFilename" value="hhc.exe" />
                    <property name="IncludeFavorites" value="False" />
                    <property name="Title" value="Transformer (NDoc)" />
                    <property name="SplitTOCs" value="False" />
                    <property name="DefaulTOC" value="" />
                    <property name="ShowVisualBasic" value="False" />
                    <property name="ShowMissingSummaries" value="True" />
                    <property name="ShowMissingRemarks" value="False" />
                    <property name="ShowMissingParams" value="True" />
                    <property name="ShowMissingReturns" value="True" />
                    <property name="ShowMissingValues" value="True" />
                    <property name="DocumentInternals" value="True" />
                    <property name="DocumentProtected" value="True" />
                    <property name="DocumentPrivates" value="False" />
                    <property name="DocumentEmptyNamespaces" value="False" />
                    <property name="IncludeAssemblyVersion" value="True" />
                    <property name="CopyrightText" value="Etomic Ltd., 2005" />
                    <property name="CopyrightHref" value="" />
                </documenter>
            </documenters>
        </ndoc>
	</target>

	<target name="publish" description="Place the compiled assets, reports etc. in agreed location.">
		<copy todir="${core.distribution}\">
			<fileset basedir="${core.output}\">
				<include name="TransformerEngine.dll"/>
				<include name="TransformerGui.exe"/>
			</fileset>
		</copy>

		<zip zipfile="${core.publish}\Transformer-Build-${sys.version}.zip">
			<fileset basedir="${core.distribution}\">
				<include name="**" />
			</fileset>
		</zip>
	</target>

	<target name="notify" description="Tell everyone of the success or failure.">
		<echo message="Notifying you of the build process success."/>
	</target>

	<target name="fail">
		<echo message="Notifying you of a failure in the build process."/>
	</target>

	<target name="fail.test">
		<nunit2report out="${core.reports}\NUnit.html">
			<fileset>
				<include name="${core.reports}\TransformerTests.dll-results.xml" />
			</fileset>
		</nunit2report>
	</target>

	<target name="help">
		<echo message="The skeleton file for the build process is designed to execute the following targets in turn:"/>
		<echo message="-- clean"/>
		<echo message="-- get"/>
		<echo message="-- version"/>
		<echo message="-- build"/>
		<echo message="-- test"/>
		<echo message="-- document"/>
		<echo message="-- publish"/>
		<echo message="-- notify"/>
		<echo message="This file should be run with a Boolean value for 'debug'."/>
		<echo message="-- True indicates that no versioning be set (0.0.0.0)."/>
		<echo message="-- False indicates that a regular version be set(1.0.x.0)."/>
		<echo message="Example: -D:debug=true"/>
	</target>

</project>